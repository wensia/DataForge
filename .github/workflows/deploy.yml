# DataForge CI/CD å·¥ä½œæµ
# æ„å»º Docker é•œåƒ â†’ æ¨é€åˆ°é˜¿é‡Œäº‘ ACR â†’ éƒ¨ç½²åˆ°æœåŠ¡å™¨

name: Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  BACKEND_IMAGE: registry.cn-hangzhou.aliyuncs.com/pandw/dataforge-backend
  FRONTEND_IMAGE: registry.cn-hangzhou.aliyuncs.com/pandw/dataforge-frontend

jobs:
  # ===== æ„å»ºåç«¯é•œåƒ =====
  build-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Alibaba ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:latest
            ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===== æ„å»ºå‰ç«¯é•œåƒ =====
  build-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Alibaba ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend-react
          file: ./frontend-react/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:latest
            ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          build-args: |
            VITE_API_BASE_URL=/api/v1
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===== éƒ¨ç½²åˆ°æœåŠ¡å™¨ =====
  deploy:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]

    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e
            cd /www/wwwroot/yunke-transit

            echo "===== 1. æ‹‰å–æœ€æ–°ä»£ç  ====="
            git fetch origin main
            git reset --hard origin/main

            echo "===== 2. ç™»å½•é˜¿é‡Œäº‘ ACR ====="
            sudo docker login registry.cn-hangzhou.aliyuncs.com -u ${{ secrets.ACR_USERNAME }} -p '${{ secrets.ACR_PASSWORD }}'

            echo "===== 3. æ‹‰å–æœ€æ–°é•œåƒ ====="
            sudo docker pull registry.cn-hangzhou.aliyuncs.com/pandw/dataforge-backend:latest
            sudo docker pull registry.cn-hangzhou.aliyuncs.com/pandw/dataforge-frontend:latest

            echo "===== 4. é‡å¯æœåŠ¡ ====="
            sudo docker compose -f docker-compose.prod.yml down --remove-orphans || true
            sudo docker compose -f docker-compose.prod.yml up -d

            echo "===== 5. æ¸…ç†æ—§é•œåƒ ====="
            sudo docker image prune -f

            echo "===== 6. æ£€æŸ¥æœåŠ¡çŠ¶æ€ ====="
            sleep 10
            sudo docker compose -f docker-compose.prod.yml ps

            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
