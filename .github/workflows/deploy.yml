# DataForge CI/CD 工作流
# 在服务器上本地构建和部署（避免跨洋推送镜像）

name: Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy and build on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -e

            echo "===== 1. 拉取最新代码 ====="
            cd /www/wwwroot/yunke-transit
            git fetch origin main
            git reset --hard origin/main

            echo "===== 2. 构建 Docker 镜像 ====="
            # 使用本地构建，利用 Docker 缓存加速
            sudo docker compose -f docker-compose.yml build --parallel

            echo "===== 3. 重启服务 ====="
            sudo docker compose -f docker-compose.yml down --remove-orphans || true
            sudo docker compose -f docker-compose.yml up -d

            echo "===== 4. 清理旧镜像 ====="
            sudo docker image prune -f

            echo "===== 5. 检查服务状态 ====="
            sleep 10
            sudo docker compose -f docker-compose.yml ps

            # 健康检查
            echo "===== 6. 健康检查 ====="
            for i in {1..30}; do
              if curl -sf http://localhost:8847/api/v1/health > /dev/null 2>&1; then
                echo "✅ 后端服务健康"
                break
              fi
              echo "等待后端启动... ($i/30)"
              sleep 2
            done

            echo "🎉 部署完成！"
